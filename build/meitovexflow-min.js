var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.EventEnumerator=function(a){this.init(a)};MeiLib.EventEnumerator.prototype.init=function(a){if(!a){throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined")}this.node=a;this.next_evnt=null;this.EoI=true;this.children=$(this.node).children();this.i_next=-1;this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")};MeiLib.EventEnumerator.prototype.read_ahead=function(){if(this.beam_enumerator){if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true;this.beam_enumerator=null;this.step_ahead()}}else{this.step_ahead()}};MeiLib.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if(a==="note"||a==="rest"||a==="mRest"||a==="chord"){this.EoI=false}else{if(a==="beam"){this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt);if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true}}}}else{this.EoI=true}};MeiLib.durationOf=function(f,c){IsSimpleEvent=function(g){return(g==="note"||g==="rest"||g==="space")};var e=function(h,i){var g=$(f).attr("dur");if(!g){throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note> or <rest> must be specified.")}return MeiLib.dur2beats(Number(g),i)};var d=function(j,h,i){if(!i){i="1"}var g=$(j).attr("dur");if(g){return MeiLib.dur2beats(Number(g),h)}$(j).find("note").each(function(){lyr_n=$(this).attr("layer");if(!lyr_n||lyr_n===i){var k=$(this).attr("dur");if(!g&&k){g=k}else{if(g&&g!=k){throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}}});if(g){return MeiLib.dur2beats(Number(g),h)}throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")};var a=function(g,i){var h=0;g.children().each(function(){var l;var k;var j=this.prop("localName");if(IsSimpleEvent(j)){l=e(this,i)}else{if(j==="chord"){l=d(this,i)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+j+"'")}}h+=l});return h};var b=$(f).prop("localName");if(IsSimpleEvent(b)){return e(f,c)}else{if(b==="mRest"){return c.count}else{if(b==="chord"){return d(f,c)}else{if(b==="beam"){return a(f,c)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'")}}}}};MeiLib.tstamp2id=function(i,h,c){var j=Number(i);var b=0;var f=function(){return b+1};var g=function(){return j-f()};var a=new MeiLib.EventEnumerator(h);var n;var l;var k;var d;while(!a.EoI&&(l===undefined||l>0)){k=n;d=l;n=a.nextEvent();l=g();b+=MeiLib.durationOf(n,c)}if(l===undefined){return undefined}var e;if(l<0){if(k&&d<Math.abs(l)){e=k}else{e=n}}else{e=n}var m;m=$(e).attr("xml:id");if(!m){m=MeiLib.createPseudoUUID();$(e).attr("xml:id",m)}return m};MeiLib.tstamp2idInContext=function(a,c){var e;var d=false;for(var b=0;b<c.length&&!d;++b){Vex.LogDebug("<<<< Measure "+b+" >>>>");if(c[b].meter){e=c[b].meter}if(b===0&&!e){throw new MeiLib.RuntimeError("MeiLib.tstamp2id:E001","No time signature specified")}}throw new MeiLib.RuntimeError("MeiLib.E002",'No event with xml:id="'+eventid+'" was found in the given MEI context.')};MeiLib.id2tstamp=function(b,d){var f;var e=false;for(var c=0;c<d.length&&!e;++c){Vex.LogDebug("<<<< Measure "+c+" >>>>");if(d[c].meter){f=d[c].meter}if(c===0&&!f){throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified")}var a=MeiLib.sumUpUntil(b,d[c].layer,f);if(a.found){e=true;return c.toString()+"m"+"+"+(a.beats+1).toString()}}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+b+'" was found in the given MEI context.')};MeiLib.dur2beats=function(a,b){return(b.unit/a)};MeiLib.beats2dur=function(a,b){return(b.unit/a)};MeiLib.sumUpUntil=function(b,c,d){var a=function(o){var g=$(o);var l=g.prop("localName");if(l==="note"||l==="rest"){if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var e=Number(g.attr("dur"));if(!e){throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).")}var j=Number(g.attr("dots"));var m=MeiLib.dur2beats(e,d);return{beats:m,found:false}}}else{if(l==="mRest"){if(g.attr("xml:id")===b){p=true;return{beats:0,found:true}}else{return{beats:d.count,found:false}}}else{if(l==="layer"||l==="beam"){var m=0;var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m+=k.beats;p=k.found}return{beats:m,found:p}}else{if(l==="chord"){var n=g.attr("dur");if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var n=g.attr("dur");if(n){if(g.find("[xml\\:id='"+b+"']")){return{beats:0,found:true}}else{return{beats:MeiLib.dur2beats(n,d),found:p}}}else{var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m=k.beats;p=k.found}return{beats:m,found:p}}}}}}}return{beats:0,found:false}};return a(c)};mei2vexflowTables={};mei2vexflowTables.positions={"above":Vex.Flow.Modifier.Position.ABOVE,"below":Vex.Flow.Modifier.Position.BELOW};mei2vexflowTables.hairpins={"cres":Vex.Flow.StaveHairpin.type.CRESC,"dim":Vex.Flow.StaveHairpin.type.DECRESC};mei2vexflowTables.articulations={"acc":"a>","stacc":"a.","ten":"a-","stacciss":"av","marc":"a^","dnbow":"am","upbow":"a|","snap":"ao","lhpizz":"a+","dot":"a.","stroke":"a|"};Node.prototype.attrs=function(){var b;var a={};for(b in this.attributes){a[this.attributes[b].name]=this.attributes[b].value}return a};Array.prototype.all=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===false){return false}}return true};Array.prototype.any=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===true){return true}}return false};MEI2VF={};MEI2VF.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};MEI2VF.render_notation=function(D,R,ao,p){var ao=ao||800;var p=p||350;var J;var a;var aa;var an=[];var aq=[];var N=[];var k={};var f=[];var af=[];var C=[];var A=[];var ae=[];var ac=50;var ay=20;var ax=0;var aj=ay;var y=0;var E=0;var au=0;var b=false;var ab=true;var K=new Array();var h={};var M=function(aB){Vex.Log("count_measures_siblings_till_sb() {}");if(aB.length===0){return 0}switch($(aB).prop("localName")){case"measure":return 1+M($(aB).next());case"sb":return 0;default:return M($(aB).next())}};var V=function(aB){J=M(aB);a=Math.round((ao-ay)/J);Vex.LogDebug("update_measure_width(): "+J+", width:"+a)};var q=function(aB){V(aB);Vex.LogDebug("startSystem() {enter}");if(ab){au=0;aj=ay;E+=1;ax=y+ac*(ax>0?1:0);ab=false;b=false;$.each(K,function(aC,aD){if(aD){aD.renderWith.clef=true;aD.renderWith.keysig=true;aD.renderWith.timesig=true}})}else{if(b){au=0;aj=ay;E+=1;ax=y+ac;b=false;$.each(K,function(aC,aD){if(aD){aD.renderWith.clef=true;aD.renderWith.keysig=true}})}}};var n=function(){if(an[an.length-1]){var aB=an[an.length-1][0];aj=aB.x+aB.width;Vex.LogDebug("moveOneMeasure(): measure_left:"+aj)}else{aj=ay}};var L=function(){return(ab||b)};var G=function(aC,aD){var aB=ag(aC,aD);if(!aB){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+aD+" is mandatory.")}return aB};var ag=function(aC,aD){var aB=$(aC).attr(aD);return aB};var F=function(aC){aC=(typeof aC==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aC;var aD=$(aC).attr("pname");var aB=$(aC).attr("oct");if(!aD||!aB){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>")}return aD+"/"+aB};var ar=function(aB){var aD=$(aB).find("syl");var aC="";$(aD).each(function(aF,aG){var aH=($(aG).attr("wordpos")=="i"||$(aG).attr("wordpos")=="m")?"-":"";aC+=(aF>0?"\n":"")+$(aG).text()+aH});var aE=(aD.attr("wordpos")=="i"||aD.attr("wordpos")=="m")?"-":"";return aC};var r=function(aF,aC){var aD=$(aF).find("dir");var aB="";var aE="";$(aD).each(function(){var aI=G(this,"startid");var aH=G(aC,"xml:id");var aG=G(this,"place");if(aI===aH){aB+=$(this).text().trim();aE=aG}});return[aB,aE]};var Q=function(aC,aB){aC={pitch:aC.split("/")[0][0],octave:Number(aC.split("/")[1])};aB={pitch:aB.split("/")[0][0],octave:Number(aB.split("/")[1])};if(aC.octave===aB.octave){if(aC.pitch===aB.pitch){return 0}else{if(aC.pitch<aB.pitch){return -1}else{if(aC.pitch>aB.pitch){return 1}}}}else{if(aC.octave<aB.octave){return -1}else{if(aC.octave>aB.octave){return 1}}}};var av=function(aB){aB=String(aB);if(aB==="1"){return"w"}if(aB==="2"){return"h"}if(aB==="4"){return"q"}if(aB==="8"){return"8"}if(aB==="16"){return"16"}if(aB==="32"){return"32"}if(aB==="64"){return"64"}throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+aB+'" is not supported.')};var i=function(aB,aE){aE=aE||true;aB=(typeof aB==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aB;var aC=$(aB).attr("dur");if(aC===undefined){alert("Could not get duration from:\n"+JSON.stringify(aB,null,"\t"))}var aD=av(aC);if(aE===true&&$(aB).attr("dots")==="1"){aD+="d"}return aD};var S=function(aB){if(aB==="n"){return"n"}if(aB==="f"){return"b"}if(aB==="s"){return"#"}if(aB==="ff"){return"bb"}if(aB==="ss"){return"##"}throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+aB)};var U=function(aC,aB){var aD=$(aC).attr("stem.dir");if(aD!==undefined){return(aD==="up")?Vex.Flow.StaveNote.STEM_UP:(aD==="down")?Vex.Flow.StaveNote.STEM_DOWN:undefined}else{var aE=H($(aB).attr("n"));if(aE==="treble"){return(Q("a/5",F(aC))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aE==="bass"){return(Q("c/3",F(aC))===-1)?Vex.Flow.StaveNote.STEM_DOWN:Vex.Flow.StaveNote.STEM_UP}}}};var am=function(aB){if($(aB).attr("key.pname")!==undefined){var aE=$(aB).attr("key.pname").toUpperCase();var aD=$(aB).attr("key.accid");if(aD!==undefined){switch(aD){case"s":aE+="#";break;case"f":aE+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}}var aC=$(aB).attr("key.mode");if(aC!==undefined){aE+=aC==="major"?"":"m"}return aE}else{return"C"}};var g=function(aB){var aC=G(aB,"clef.shape");var aD=ag(aB,"clef.line");if(aC==="G"&&(!aD||aD==="2")){return"treble"}else{if(aC==="F"&&(!aD||aD==="4")){return"bass"}else{if(aC==="C"&&aD==="3"){return"alto"}else{if(aC==="C"&&aD==="4"){return"tenor"}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+aC+'" '+(aD?('clef.line="'+aD+'"'):"")+" ]")}}}}};var H=function(aB){if(aB>=K.length){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.staff_clef():E01","No staff definition for staff n="+aB)}var aC=K[aB].staffDef;return g(aC)};var aA=function(aB){if($(aB).attr("meter.count")!==undefined&&$(aB).attr("meter.unit")!==undefined){return $(aB).attr("meter.count")+"/"+$(aB).attr("meter.unit")}};var ai=function(aB){var aC=new Vex.Flow.Renderer(aB,Vex.Flow.Renderer.Backends.CANVAS);aa=aC.getContext()};var w=function(aB){return 100};var l=function(aD){var aB=0;var aC;for(aC=0;aC<aD-1;aC++){aB+=w(aC)}return aB};var j=function(aD){var aB=ax+l(aD);var aC=aB+w(aD);if(aC>y){y=aC}return aB};var ad=function(aD,aC){if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".')}var aE=K[aD].staffDef;var aB=new Vex.Flow.Stave(aj,j(aD),aC);if(K[aD].renderWith.clef){aB.addClef(g(aE));K[aD].renderWith.clef=false}if(K[aD].renderWith.keysig){if($(aE).attr("key.sig.show")==="true"||$(aE).attr("key.sig.show")===undefined){aB.addKeySignature(am(aE))}K[aD].renderWith.keysig=false}if(K[aD].renderWith.timesig){if($(aE).attr("meter.rend")==="norm"||$(aE).attr("meter.rend")===undefined){aB.addTimeSignature(aA(aE))}K[aD].renderWith.timesig=false}aB.setContext(aa).draw();return aB};var ah=function(){var aB=$(D).find("scoreDef")[0];if(!aB){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.")}t(aB);$(D).find("section").children().each(P);$.each(aq,function(aD,aC){aC.setContext(aa).draw()});O(af);O(C);az(A)};var O=function(aB){$(aB).each(function(aF,aG){var aD=k[aG.getFirstId()];var aH=k[aG.getLastId()];var aE;if(aD){aE=aD.vexNote}var aC;if(aH){aC=aH.vexNote}new Vex.Flow.StaveTie({first_note:aE,last_note:aC}).setContext(aa).draw()})};var az=function(aB){$(aB).each(function(aE,aJ){var aK=k[aJ.getFirstId()];var aG=k[aJ.getLastId()];var aI;if(aK){aI=aK.vexNote}var aC;if(aG){aC=aG.vexNote}var aD=mei2vexflowTables.positions[aJ.params.place];var aH=mei2vexflowTables.hairpins[aJ.params.form];var aF=0;var aM=0;var aL={height:10,y_shift:0,left_shift_px:aF,r_shift_px:aM};new Vex.Flow.StaveHairpin({first_note:aI,last_note:aC,},aH).setContext(aa).setRenderOptions(aL).setPosition(aD).draw()})};var at=function(){for(var aE in h){var aF=h[aE];var aB=aF.vexType();var aC=f[aF.top_staff_n];var aD=f[aF.bottom_staff_n];if(aB&&aC&&aD){var aG=new Vex.Flow.StaveConnector(aC,aD);aG.setType(aF.vexType());aG.setContext(aa);aG.draw()}}};var P=function(aB,aD){switch($(aD).prop("localName")){case"measure":var aC;if(L()){q(aD);aC=true}else{n();aC=false}u(aD);if(aC){at();aC=false}aw(aD,"tie",af);aw(aD,"slur",C);aw(aD,"hairpin",A);break;case"scoreDef":t(aD);break;case"staffDef":x(aD);break;case"sb":Z(aD);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aD).prop("localName")+"> is not supported in <section>")}};var Z=function(aB){b=true};var t=function(aB){$(aB).children().each(X)};var X=function(aB,aC){switch($(aC).prop("localName")){case"staffGrp":c(aC);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aC).prop("localName")+"> is not supported in <scoreDef>")}};var c=function(aD){var aB={};var aC=aD.attrs().symbol;$(aD).children().each(function(aF,aG){var aE=ak(aF,aG);Vex.LogDebug("process_staffGrp() {1}.{a}: local_result.first_n:"+aE.first_n+" local_result.last_n:"+aE.last_n);if(aF===0){aB.first_n=aE.first_n;aB.last_n=aE.last_n}else{aB.last_n=aE.last_n}});Vex.LogDebug("process_staffGrp() {2}: symbol:"+aC+" result.first_n:"+aB.first_n+" result.last_n:"+aB.last_n);h[aB.first_n.toString()+":"+aB.last_n.toString()]=new MEI2VF.StaveConnector(aC,aB.first_n,aB.last_n);return aB};var ak=function(aB,aD){switch($(aD).prop("localName")){case"staffDef":var aC=x(aD);return{first_n:aC,last_n:aC};break;case"staffGrp":return c(aD);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aD).prop("localName")+"> is not supported in <staffGrp>")}};var x=function(aB){var aC=Number(aB.attrs().n);var aD=K[aC];if(aD){K[aC].updateDef(aB)}else{K[aC]=new MEI2VF.StaffInfo(aB,true,true,true)}return aC};var u=function(aB){an.push($(aB).find("staff").map(function(aD,aC){return al(aD,aC,aB)}).get())};var al=function(aD,aH,aG){var aL,aB,aJ;var aC=Number(aH.attrs().n);aL=ad(aC,a);var aI=$(aH).find("layer").map(function(aN,aM){return W(aN,aM,aH,aG)}).get();var aE=[];$(aI).each(function(){aE.push({events:$(this.events).get().map(function(aM){return aM.vexNote?aM.vexNote:aM}),layer:this.layer})});var aF=$.map(aE,function(aM){return T(null,aM.events)});var aK=new Vex.Flow.Formatter().joinVoices(aF).format(aF,a).formatToStave(aF,aL);$.each(aF,function(aM,aN){aN.draw(aa,aL)});f[aC]=aL;return aL};var W=function(aE,aF,aH,aG){var aB=aG.attrs().n;if(!aB){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified")}var aD=aH.attrs().n;if(!aD){aD="1"}var aC=aF.attrs().n;if(!aC){aC="1"}var aI=K[aD].staffDef;var aJ=aB+":"+aD+":"+aC;if(ae[aJ]){$(ae[aJ]).each(function(aK,aL){var aN=$(aI).attr("meter.count");var aM=$(aI).attr("meter.unit");var aO={count:Number(aN),unit:Number(aM)};aL.setContext({layer:aF,meter:aO});ae[aJ][aK]=null});ae[aJ]=null}return{layer:aE,events:$(aF).children().map(function(aL,aK){return I(aK,aF,aH,aG)}).get()}};var aw=function(aH,aI,aD){var aB=function(aL){var aK=aL.attrs().staff;if(!aK){aK="1"}var aJ=aL.attrs().layer;if(!aJ){aJ="1"}return{staff_n:aK,layer_n:aJ}};var aC=function(aN,aL,aJ){var aP=aB(aL);var aR=$(aJ).find('staff[n="'+aP.staff_n+'"]');var aM=$(aR).find('layer[n="'+aP.layer_n+'"]').get(0);if(!aM){var aQ=$(aR).find("layer");if(aQ&&!aQ.attr("n")){aM=aQ}if(!aM){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}}var aO=K[aP.staff_n].staffDef;if(!aO){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.")}var aK={count:Number(aO.attrs()["meter.count"]),unit:Number(aO.attrs()["meter.unit"])};if(!aK.count||!aK.unit){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.")}return MeiLib.tstamp2id(aN,aM,aK)};var aG=function(aK){var aJ;return aK.substring(0,aK.indexOf("m"))};var aE=function(aK){var aJ;return aK.substring(aK.indexOf("+")+1)};var aF=$(aH).find(aI);$.each(aF,function(aT,aR){var aM=new MEI2VF.EventLink(null,null);if(aI==="hairpin"){var aL=aR.attrs().form;if(!aL){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.")}var aP=aR.attrs().place;aM.setParams({form:aL,place:aP})}var aO=aR.attrs().startid;if(aO){aM.setFirstId(aO)}else{var aU=aR.attrs().tstamp;if(aU){aO=aC(aU,aR,aH);aM.setFirstId(aO)}else{}}var aS=aR.attrs().endid;if(aS){aM.setLastId(aS)}else{var aQ=aR.attrs().tstamp2;if(aQ){var aN=Number(aG(aQ));if(aN>0){aM.setLastTStamp(aE(aQ));var aK=aB(aR);var aJ=aH.attrs().n;var aV=Number(aJ)+aN;var aW=aV.toString()+":"+aK.staff_n+":"+aK.layer_n;if(!ae[aW]){ae[aW]=new Array()}ae[aW].push(aM)}else{aS=aC(aE(aQ),aR,aH);aM.setLastId(aS)}}else{}}aD.push(aM)})};var s=function(aE,aD,aB){var aC=new MEI2VF.EventLink(aE,aD);aB.push(aC)};var v=function(aE,aB,aC){var aD=new MEI2VF.EventLink(aE,null);aD.setParams({linkCond:aB});aC.push(aD)};var z=function(aG,aB){var aC=function(aI,aH){return(aI&&aH&&aI.pname===aH.pname&&aI.oct===aH.oct&&aI.system===aH.system)};if(!aB.pname||!aB.oct){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or specified for the tie")}var aF=false;var aD;var aE;for(aD=0;!aF&&aD<af.length;++aD){aE=af[aD];if(!aE.getLastId()){if(aC(aE.params.linkCond,aB)){aF=true;aE.setLastId(aG)}else{}}}if(!aF){var aE=new MEI2VF.EventLink(null,aG);af.push(aE)}};var e=function(aH,aB){var aD=function(aJ,aI){return aJ.nesting_level===aI.nesting_level&&aJ.system===aI.system};var aG=false;var aF=0;var aC;for(aF=0;!aG&&aF<C.length;++aF){var aE=C[aF];if(aE&&!aE.getLastId()&&aD(aE.params.linkCond,aB)){aG=true;aE.setLastId(aH)}}if(!aG){var aE=new MEI2VF.EventLink(null,aH);C.push(aE)}};var d=function(aC){var aB=[];var aD=aC.split(" ");$.each(aD,function(aF,aG){var aE;if(aG.length===1){aB.push({letter:aG,nesting_level:0})}else{if(aG.length===2){if(!(aE=Number(aG[1]))){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}aB.push({letter:aG[0],nesting_level:aE})}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}}});return aB};var m=function(aC,aH,aS,aJ){var aQ=function(aT){return(new Vex.Flow.Annotation(aT)).setFont("Times").setBottom(true)};var aB=function(aT){return(new Vex.Flow.Annotation(aT)).setFont("Times")};try{var aE=new Vex.Flow.StaveNote({keys:[F(aC)],clef:H($(aS).attr("n")),duration:i(aC),stem_direction:U(aC,aS)});aE.addAnnotation(2,aQ(ar(aC)));var aK=r(aJ,aC);aE.addAnnotation(2,aK[1]=="below"?aQ(aK[0]):aB(aK[0]));try{var aR;for(aR=0;aR<parseInt($(aC).attr("dots"));aR++){aE.addDotToAll()}}catch(aL){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(aC.attrs())+'. "'+aL.toString()+'"')}var aG=$(aC).attr("accid");if(aG){aE.addAccidental(0,new Vex.Flow.Accidental(S(aG)))}$.each($(aC).find("artic"),function(aU,aT){aE.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(aT).attr("artic")]).setPosition(mei2vexflowTables.positions[$(aT).attr("place")]))});$.each($(aC).children(),function(aT,aU){$(aU).remove()});var aI=$(aC).attr("xml:id");if(!aI){aI=MeiLib.createPseudoUUID();$(aC).attr("xml:id",aI)}var aM=$(aC).attr("tie");if(!aM){aM=""}var aD=$(aC).attr("pname");if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute")}var aP=$(aC).attr("oct");if(!aP){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute")}for(var aR=0;aR<aM.length;++aR){switch(aM[aR]){case"i":v(aI,{pname:aD,oct:aP,system:E},af);break;case"t":z(aI,{pname:aD,oct:aP,system:E});break}}var aF=$(aC).attr("slur");if(aF){var aN=d(aF);$.each(aN,function(aU,aT){switch(aT.letter){case"i":v(aI,{nesting_level:aT.nesting_level,system:E},C);break;case"t":e(aI,{nesting_level:aT.nesting_level,system:E});break}})}var aO={vexNote:aE,id:aI};N.push(aO);k[aI]={meiNote:aC,vexNote:aE};return aO}catch(aL){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(aC.attrs())+'. "'+aL.toString()+'"')}};var Y=function(aE,aD,aC,aG){try{var aF=new Vex.Flow.StaveNote({keys:["c/5"],duration:i(aE,false)+"r"});if($(aE).attr("dots")==="1"){aF.addDotToAll()}return aF}catch(aB){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(aE.attrs())+'. "'+aB.toString()+'"')}};var ap=function(aE,aD,aC,aG){try{var aF=new Vex.Flow.StaveNote({keys:["c/5"],duration:"wr"});return aF}catch(aB){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(aE.attrs())+'. "'+aB.toString()+'"')}};var o=function(aD,aC,aB,aF){var aE=$(aD).children().map(function(aG,aH){var aI=I(aH,aC,aB,aF);return aI.vexNote?aI.vexNote:aI}).get();aq.push(new Vex.Flow.Beam(aE));return aE};var B=function(aE,aB,aH,aG){try{var aJ=$(aE).children().map(F).get();var aC=av(Math.max.apply(Math,$(aE).children().map(function(){return Number($(this).attr("dur"))}).get()));var aF=$(aE).children().map(function(){return $(this).attr("dots")==="1"}).get().any();if(aF===true){aC+="d"}var aD=new Vex.Flow.StaveNote({keys:aJ,clef:H($(aH).attr("n")),duration:aC});if(aF===true){aD.addDotToAll()}$(aE).children().each(function(aL,aM){var aK=$(aM).attr("accid");if(aK!==undefined){aD.addAccidental(aL,new Vex.Flow.Accidental(S(aK)))}});return aD}catch(aI){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+aI.toString())}};var I=function(aD,aC,aB,aF){var aE=$(aD).prop("localName");if(aE==="rest"){return Y(aD,aC,aB,aF)}else{if(aE==="mRest"){return ap(aD,aC,aB,aF)}else{if(aE==="note"){return m(aD,aC,aB,aF)}else{if(aE==="beam"){return o(aD,aC,aB,aF)}else{if(aE==="chord"){return B(aD,aC,aB,aF)}else{throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+aE+'" is not supported.')}}}}}};var T=function(aC,aB){if(!$.isArray(aB)){throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.")}var aD=new Vex.Flow.Voice({num_beats:Number($(D).find("staffDef").attr("meter.count")),beat_value:Number($(D).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});aD.setStrict(false);aD.addTickables(aB);return aD};ai(R);ah()};MEI2VF.EventLink=function(b,a){this.init(b,a)};MEI2VF.EventLink.prototype.init=function(b,a){this.first_ref=new MEI2VF.EventReference(b);this.last_ref=new MEI2VF.EventReference(a);this.params={}};MEI2VF.EventLink.prototype.setParams=function(a){this.params=a};MEI2VF.EventLink.prototype.setFirstRef=function(a){this.first_ref=a};MEI2VF.EventLink.prototype.setLastRef=function(a){this.last_ref=a};MEI2VF.EventLink.prototype.setFirstId=function(a){this.first_ref.setId(a)};MEI2VF.EventLink.prototype.setLastId=function(a){this.last_ref.setId(a)};MEI2VF.EventLink.prototype.setFirstTStamp=function(a){this.first_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setLastTStamp=function(a){this.last_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setContext=function(a){this.meicontext=a};MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})};MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})};MEI2VF.EventReference=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setId=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setTStamp=function(a){this.tstamp=a;if(this.xmlid){this.tryResolveReference(true)}};MEI2VF.EventReference.prototype.tryResolveReference=function(b){var a=this.tstamp;var c=this.meicontext;if(!a){throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.")}if(this.meicontext){this.xmlid=MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter)}else{this.xmlid=null}};MEI2VF.EventReference.prototype.getId=function(a){if(a&&a.meicontext){this.setContext(a.meicontext)}if(this.xmlid){return this.xmlid}if(this.tstamp){if(this.meicontext){this.tryResolveReference(a&&a.strict);return this.xmlid}}return null};MEI2VF.EventReference.prototype.setContext=function(a){this.meicontext=a};MEI2VF.StaffInfo=function(b,d,c,a){this.renderWith={clef:d,keysig:c,timesig:a};this.staffDef=b};MEI2VF.StaffInfo.prototype.look4changes=function(c,d){var a={clef:false,keysig:false,timesig:false};if(!c&&d){a.clef=true;a.keysig=true;a.keysig=true;return a}else{if(c&&!d){a.clef=false;a.keysig=false;a.keysig=false;return a}else{if(!c&&!d){throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.")}}}var b=function(g,e,f){return $(g).attr(f)===$(e).attr(f)};if(!b(c,d,"clef.shape")||!b(c,d,"clef.line")){a.clef=true}if((!b(c,d,"key.pname")||!b(c,d,"key.accid")||!b(c,d))){a.keysig=true}if(!b(c,d,"meter.count")||!b(c,d,"meter.unit")){a.timesig=true}return a};MEI2VF.StaffInfo.prototype.updateDef=function(a){this.renderWith=this.look4changes(this.staffDef,a);this.staffDef=a};MEI2VF.StaveConnector=function(b,a,c){this.init(b,a,c)};MEI2VF.StaveConnector.prototype.init=function(b,a,c){this.symbol=b;this.top_staff_n=a;this.bottom_staff_n=c};MEI2VF.StaveConnector.prototype.vexType=function(){switch(this.symbol){case"line":return Vex.Flow.StaveConnector.type.SINGLE;case"brace":return Vex.Flow.StaveConnector.type.BRACE;case"bracket":return Vex.Flow.StaveConnector.type.BRACKET;case"none":return null;default:return Vex.Flow.StaveConnector.type.SINGLE}};