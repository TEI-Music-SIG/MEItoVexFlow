var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.EventEnumerator=function(a){this.init(a)};MeiLib.EventEnumerator.prototype.init=function(a){if(!a){throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined")}this.node=a;this.next_evnt=null;this.EoI=true;this.children=$(this.node).children();this.i_next=-1;this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")};MeiLib.EventEnumerator.prototype.read_ahead=function(){if(this.beam_enumerator){if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true;this.beam_enumerator=null;this.step_ahead()}}else{this.step_ahead()}};MeiLib.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if(a==="note"||a==="rest"||a==="mRest"||a==="chord"){this.EoI=false}else{if(a==="beam"){this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt);if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true}}}}else{this.EoI=true}};MeiLib.durationOf=function(f,c){IsSimpleEvent=function(g){return(g==="note"||g==="rest"||g==="space")};var e=function(h,i){var g=$(f).attr("dur");if(!g){throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note> or <rest> must be specified.")}return MeiLib.dur2beats(Number(g),i)};var d=function(j,h,i){if(!i){i="1"}var g=$(j).attr("dur");if(g){return MeiLib.dur2beats(Number(g),h)}$(j).find("note").each(function(){lyr_n=$(this).attr("layer");if(!lyr_n||lyr_n===i){var k=$(this).attr("dur");if(!g&&k){g=k}else{if(g&&g!=k){throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}}});if(g){return MeiLib.dur2beats(Number(g),h)}throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")};var a=function(g,i){var h=0;g.children().each(function(){var l;var k;var j=this.prop("localName");if(IsSimpleEvent(j)){l=e(this,i)}else{if(j==="chord"){l=d(this,i)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+j+"'")}}h+=l});return h};var b=$(f).prop("localName");if(IsSimpleEvent(b)){return e(f,c)}else{if(b==="mRest"){return c.count}else{if(b==="chord"){return d(f,c)}else{if(b==="beam"){return a(f,c)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'")}}}}};MeiLib.tstamp2id=function(i,h,c){var j=Number(i);var b=0;var f=function(){return b+1};var g=function(){return j-f()};var a=new MeiLib.EventEnumerator(h);var n;var l;var k;var d;while(!a.EoI&&(l===undefined||l>0)){k=n;d=l;n=a.nextEvent();l=g();b+=MeiLib.durationOf(n,c)}if(l===undefined){return undefined}var e;if(l<0){if(k&&d<Math.abs(l)){e=k}else{e=n}}else{e=n}var m;m=$(e).attr("xml:id");if(!m){m=MeiLib.createPseudoUUID();$(e).attr("xml:id",m)}return m};MeiLib.tstamp2idInContext=function(a,c){var e;var d=false;for(var b=0;b<c.length&&!d;++b){Vex.LogDebug("<<<< Measure "+b+" >>>>");if(c[b].meter){e=c[b].meter}if(b===0&&!e){throw new MeiLib.RuntimeError("MeiLib.tstamp2id:E001","No time signature specified")}}throw new MeiLib.RuntimeError("MeiLib.E002",'No event with xml:id="'+eventid+'" was found in the given MEI context.')};MeiLib.id2tstamp=function(b,d){var f;var e=false;for(var c=0;c<d.length&&!e;++c){Vex.LogDebug("<<<< Measure "+c+" >>>>");if(d[c].meter){f=d[c].meter}if(c===0&&!f){throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified")}var a=MeiLib.sumUpUntil(b,d[c].layer,f);if(a.found){e=true;return c.toString()+"m"+"+"+(a.beats+1).toString()}}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+b+'" was found in the given MEI context.')};MeiLib.dur2beats=function(a,b){return(b.unit/a)};MeiLib.beats2dur=function(a,b){return(b.unit/a)};MeiLib.sumUpUntil=function(b,c,d){var a=function(o){var g=$(o);var l=g.prop("localName");if(l==="note"||l==="rest"){if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var e=Number(g.attr("dur"));if(!e){throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).")}var j=Number(g.attr("dots"));var m=MeiLib.dur2beats(e,d);return{beats:m,found:false}}}else{if(l==="mRest"){if(g.attr("xml:id")===b){p=true;return{beats:0,found:true}}else{return{beats:d.count,found:false}}}else{if(l==="layer"||l==="beam"){var m=0;var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m+=k.beats;p=k.found}return{beats:m,found:p}}else{if(l==="chord"){var n=g.attr("dur");if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var n=g.attr("dur");if(n){if(g.find("[xml\\:id='"+b+"']")){return{beats:0,found:true}}else{return{beats:MeiLib.dur2beats(n,d),found:p}}}else{var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m=k.beats;p=k.found}return{beats:m,found:p}}}}}}}return{beats:0,found:false}};return a(c)};mei2vexflowTables={};mei2vexflowTables.positions={"above":Vex.Flow.Modifier.Position.ABOVE,"below":Vex.Flow.Modifier.Position.BELOW};mei2vexflowTables.hairpins={"cres":Vex.Flow.StaveHairpin.type.CRESC,"dim":Vex.Flow.StaveHairpin.type.DECRESC};mei2vexflowTables.articulations={"acc":"a>","stacc":"a.","ten":"a-","stacciss":"av","marc":"a^","dnbow":"am","upbow":"a|","snap":"ao","lhpizz":"a+","dot":"a.","stroke":"a|"};Node.prototype.attrs=function(){var b;var a={};for(b in this.attributes){a[this.attributes[b].name]=this.attributes[b].value}return a};Array.prototype.all=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===false){return false}}return true};Array.prototype.any=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===true){return true}}return false};MEI2VF={};MEI2VF.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};MEI2VF.render_notation=function(E,S,ap,p){var ap=ap||800;var p=p||350;var K;var a;var ab;var ao=[];var ar=[];var O=[];var k={};var f=[];var ag=[];var C=[];var A=[];var af=[];var ad=50;var az=20;var ay=0;var ak=az;var y=0;var F=0;var av=0;var b=false;var ac=true;var L=new Array();var aB=0;var h={};var D=new MEI2VF.StaveVoices();var N=function(aD){Vex.Log("count_measures_siblings_till_sb() {}");if(aD.length===0){return 0}switch($(aD).prop("localName")){case"measure":return 1+N($(aD).next());case"sb":return 0;default:return N($(aD).next())}};var W=function(aD){K=N(aD);a=Math.round((ap-az)/K);Vex.LogDebug("update_measure_width(): "+K+", width:"+a)};var q=function(aD){W(aD);Vex.LogDebug("startSystem() {enter}");if(ac){av=0;ak=az;F+=1;ay=y+ad*(ay>0?1:0);ac=false;b=false;$.each(L,function(aE,aF){if(aF){aF.renderWith.clef=true;aF.renderWith.keysig=true;aF.renderWith.timesig=true}})}else{if(b){av=0;ak=az;F+=1;ay=y+ad;b=false;$.each(L,function(aE,aF){if(aF){aF.renderWith.clef=true;aF.renderWith.keysig=true}})}}};var n=function(){if(ao[ao.length-1]){var aD=ao[ao.length-1][0];ak=aD.x+aD.width;Vex.LogDebug("moveOneMeasure(): measure_left:"+ak)}else{ak=az}};var M=function(){return(ac||b)};var H=function(aE,aF){var aD=ah(aE,aF);if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+aF+" is mandatory.")}return aD};var ah=function(aE,aF){var aD=$(aE).attr(aF);return aD};var G=function(aE){aE=(typeof aE==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aE;var aF=$(aE).attr("pname");var aD=$(aE).attr("oct");if(!aF||!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>")}return aF+"/"+aD};var at=function(aD){var aF=$(aD).find("syl");var aE="";$(aF).each(function(aH,aI){var aJ=($(aI).attr("wordpos")=="i"||$(aI).attr("wordpos")=="m")?"-":"";aE+=(aH>0?"\n":"")+$(aI).text()+aJ});var aG=(aF.attr("wordpos")=="i"||aF.attr("wordpos")=="m")?"-":"";return aE};var r=function(aH,aE){var aF=$(aH).find("dir");var aD="";var aG="";$(aF).each(function(){var aK=H(this,"startid");var aJ=H(aE,"xml:id");var aI=H(this,"place");if(aK===aJ){aD+=$(this).text().trim();aG=aI}});return[aD,aG]};var R=function(aE,aD){aE={pitch:aE.split("/")[0][0],octave:Number(aE.split("/")[1])};aD={pitch:aD.split("/")[0][0],octave:Number(aD.split("/")[1])};if(aE.octave===aD.octave){if(aE.pitch===aD.pitch){return 0}else{if(aE.pitch<aD.pitch){return -1}else{if(aE.pitch>aD.pitch){return 1}}}}else{if(aE.octave<aD.octave){return -1}else{if(aE.octave>aD.octave){return 1}}}};var aw=function(aD){aD=String(aD);if(aD==="1"){return"w"}if(aD==="2"){return"h"}if(aD==="4"){return"q"}if(aD==="8"){return"8"}if(aD==="16"){return"16"}if(aD==="32"){return"32"}if(aD==="64"){return"64"}throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+aD+'" is not supported.')};var i=function(aD,aG){aG=aG||true;aD=(typeof aD==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:aD;var aE=$(aD).attr("dur");if(aE===undefined){alert("Could not get duration from:\n"+JSON.stringify(aD,null,"\t"))}var aF=aw(aE);if(aG===true&&$(aD).attr("dots")==="1"){aF+="d"}return aF};var T=function(aD){if(aD==="n"){return"n"}if(aD==="f"){return"b"}if(aD==="s"){return"#"}if(aD==="ff"){return"bb"}if(aD==="ss"){return"##"}throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+aD)};var V=function(aE,aD){var aF=$(aE).attr("stem.dir");if(aF!==undefined){return(aF==="up")?Vex.Flow.StaveNote.STEM_UP:(aF==="down")?Vex.Flow.StaveNote.STEM_DOWN:undefined}else{var aG=I($(aD).attr("n"));if(aG==="treble"){return(R("a/5",G(aE))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aG==="bass"){return(R("c/3",G(aE))===-1)?Vex.Flow.StaveNote.STEM_DOWN:Vex.Flow.StaveNote.STEM_UP}}}};var an=function(aD){if($(aD).attr("key.pname")!==undefined){var aG=$(aD).attr("key.pname").toUpperCase();var aF=$(aD).attr("key.accid");if(aF!==undefined){switch(aF){case"s":aG+="#";break;case"f":aG+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}}var aE=$(aD).attr("key.mode");if(aE!==undefined){aG+=aE==="major"?"":"m"}return aG}else{return"C"}};var g=function(aD){var aE=H(aD,"clef.shape");var aF=ah(aD,"clef.line");if(aE==="G"&&(!aF||aF==="2")){return"treble"}else{if(aE==="F"&&(!aF||aF==="4")){return"bass"}else{if(aE==="C"&&aF==="3"){return"alto"}else{if(aE==="C"&&aF==="4"){return"tenor"}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+aE+'" '+(aF?('clef.line="'+aF+'"'):"")+" ]")}}}}};var I=function(aD){if(aD>=L.length){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.staff_clef():E01","No staff definition for staff n="+aD)}var aE=L[aD].staffDef;return g(aE)};var aC=function(aD){if($(aD).attr("meter.count")!==undefined&&$(aD).attr("meter.unit")!==undefined){return $(aD).attr("meter.count")+"/"+$(aD).attr("meter.unit")}};var aj=function(aD){var aE=new Vex.Flow.Renderer(aD,Vex.Flow.Renderer.Backends.CANVAS);ab=aE.getContext()};var w=function(aD){return 100};var l=function(aF){var aD=0;var aE;for(aE=0;aE<aF-1;aE++){aD+=w(aE)}return aD};var j=function(aF){var aD=ay+l(aF);var aE=aD+w(aF);if(aE>y){y=aE}return aD};var ae=function(aF,aE){if(!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".')}var aG=L[aF].staffDef;var aD=new Vex.Flow.Stave(ak,j(aF),aE);if(L[aF].renderWith.clef){aD.addClef(g(aG));L[aF].renderWith.clef=false}if(L[aF].renderWith.keysig){if($(aG).attr("key.sig.show")==="true"||$(aG).attr("key.sig.show")===undefined){aD.addKeySignature(an(aG))}L[aF].renderWith.keysig=false}if(L[aF].renderWith.timesig){if($(aG).attr("meter.rend")==="norm"||$(aG).attr("meter.rend")===undefined){aD.addTimeSignature(aC(aG))}L[aF].renderWith.timesig=false}aD.setContext(ab).draw();aB=aD.barXShift;Vex.LogDebug("initialise_staff_n(): staffXShift="+aB);return aD};var ai=function(){var aD=$(E).find("scoreDef")[0];if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.")}t(aD);$(E).find("section").children().each(Q);$.each(ar,function(aF,aE){aE.setContext(ab).draw()});P(ag);P(C);aA(A)};var P=function(aD){$(aD).each(function(aH,aI){var aF=k[aI.getFirstId()];var aJ=k[aI.getLastId()];var aG;if(aF){aG=aF.vexNote}var aE;if(aJ){aE=aJ.vexNote}new Vex.Flow.StaveTie({first_note:aG,last_note:aE}).setContext(ab).draw()})};var aA=function(aD){$(aD).each(function(aG,aL){var aM=k[aL.getFirstId()];var aI=k[aL.getLastId()];var aK;if(aM){aK=aM.vexNote}var aE;if(aI){aE=aI.vexNote}var aF=mei2vexflowTables.positions[aL.params.place];var aJ=mei2vexflowTables.hairpins[aL.params.form];var aH=0;var aO=0;var aN={height:10,y_shift:0,left_shift_px:aH,r_shift_px:aO};new Vex.Flow.StaveHairpin({first_note:aK,last_note:aE,},aJ).setContext(ab).setRenderOptions(aN).setPosition(aF).draw()})};var au=function(){for(var aG in h){var aH=h[aG];var aD=aH.vexType();var aE=f[aH.top_staff_n];var aF=f[aH.bottom_staff_n];if(aD&&aE&&aF){var aI=new Vex.Flow.StaveConnector(aE,aF);aI.setType(aH.vexType());aI.setContext(ab);aI.draw()}}};var Q=function(aD,aF){switch($(aF).prop("localName")){case"measure":var aE;if(M()){q(aF);aE=true}else{n();aE=false}D.reset();u(aF);if(aE){au();aE=false}D.format(a-aB-20);D.draw(ab,f);ax(aF,"tie",ag);ax(aF,"slur",C);ax(aF,"hairpin",A);break;case"scoreDef":t(aF);break;case"staffDef":x(aF);break;case"sb":aa(aF);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aF).prop("localName")+"> is not supported in <section>")}};var aa=function(aD){b=true};var t=function(aD){$(aD).children().each(Y)};var Y=function(aD,aE){switch($(aE).prop("localName")){case"staffGrp":c(aE);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aE).prop("localName")+"> is not supported in <scoreDef>")}};var c=function(aF){var aD={};var aE=aF.attrs().symbol;$(aF).children().each(function(aH,aI){var aG=al(aH,aI);Vex.LogDebug("process_staffGrp() {1}.{a}: local_result.first_n:"+aG.first_n+" local_result.last_n:"+aG.last_n);if(aH===0){aD.first_n=aG.first_n;aD.last_n=aG.last_n}else{aD.last_n=aG.last_n}});Vex.LogDebug("process_staffGrp() {2}: symbol:"+aE+" result.first_n:"+aD.first_n+" result.last_n:"+aD.last_n);h[aD.first_n.toString()+":"+aD.last_n.toString()]=new MEI2VF.StaveConnector(aE,aD.first_n,aD.last_n);return aD};var al=function(aD,aF){switch($(aF).prop("localName")){case"staffDef":var aE=x(aF);return{first_n:aE,last_n:aE};break;case"staffGrp":return c(aF);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(aF).prop("localName")+"> is not supported in <staffGrp>")}};var x=function(aD){var aE=Number(aD.attrs().n);var aF=L[aE];if(aF){L[aE].updateDef(aD)}else{L[aE]=new MEI2VF.StaffInfo(aD,true,true,true)}return aE};var u=function(aD){ao.push($(aD).find("staff").map(function(aF,aE){return am(aF,aE,aD)}).get())};var am=function(aF,aI,aH){var aL,aD,aK;var aE=Number(aI.attrs().n);aL=ae(aE,a);var aJ=$(aI).find("layer").map(function(aN,aM){return X(aN,aM,aI,aH)}).get();var aG=[];$(aJ).each(function(){var aM=$(this.events).get().map(function(aN){return aN.vexNote?aN.vexNote:aN});D.addVoice(U(null,aM),aE)});f[aE]=aL;return aL};var X=function(aG,aH,aJ,aI){var aD=aI.attrs().n;if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified")}var aF=aJ.attrs().n;if(!aF){aF="1"}var aE=aH.attrs().n;if(!aE){aE="1"}var aK=L[aF].staffDef;var aL=aD+":"+aF+":"+aE;if(af[aL]){$(af[aL]).each(function(aM,aN){var aP=$(aK).attr("meter.count");var aO=$(aK).attr("meter.unit");var aQ={count:Number(aP),unit:Number(aO)};aN.setContext({layer:aH,meter:aQ});af[aL][aM]=null});af[aL]=null}return{layer:aG,events:$(aH).children().map(function(aN,aM){return J(aM,aH,aJ,aI)}).get()}};var ax=function(aJ,aK,aF){var aD=function(aN){var aM=aN.attrs().staff;if(!aM){aM="1"}var aL=aN.attrs().layer;if(!aL){aL="1"}return{staff_n:aM,layer_n:aL}};var aE=function(aP,aN,aL){var aR=aD(aN);var aT=$(aL).find('staff[n="'+aR.staff_n+'"]');var aO=$(aT).find('layer[n="'+aR.layer_n+'"]').get(0);if(!aO){var aS=$(aT).find("layer");if(aS&&!aS.attr("n")){aO=aS}if(!aO){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}}var aQ=L[aR.staff_n].staffDef;if(!aQ){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.")}var aM={count:Number(aQ.attrs()["meter.count"]),unit:Number(aQ.attrs()["meter.unit"])};if(!aM.count||!aM.unit){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.")}return MeiLib.tstamp2id(aP,aO,aM)};var aI=function(aM){var aL;return aM.substring(0,aM.indexOf("m"))};var aG=function(aM){var aL;return aM.substring(aM.indexOf("+")+1)};var aH=$(aJ).find(aK);$.each(aH,function(aV,aT){var aO=new MEI2VF.EventLink(null,null);if(aK==="hairpin"){var aN=aT.attrs().form;if(!aN){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.")}var aR=aT.attrs().place;aO.setParams({form:aN,place:aR})}var aQ=aT.attrs().startid;if(aQ){aO.setFirstId(aQ)}else{var aW=aT.attrs().tstamp;if(aW){aQ=aE(aW,aT,aJ);aO.setFirstId(aQ)}else{}}var aU=aT.attrs().endid;if(aU){aO.setLastId(aU)}else{var aS=aT.attrs().tstamp2;if(aS){var aP=Number(aI(aS));if(aP>0){aO.setLastTStamp(aG(aS));var aM=aD(aT);var aL=aJ.attrs().n;var aX=Number(aL)+aP;var aY=aX.toString()+":"+aM.staff_n+":"+aM.layer_n;if(!af[aY]){af[aY]=new Array()}af[aY].push(aO)}else{aU=aE(aG(aS),aT,aJ);aO.setLastId(aU)}}else{}}aF.push(aO)})};var s=function(aG,aF,aD){var aE=new MEI2VF.EventLink(aG,aF);aD.push(aE)};var v=function(aG,aD,aE){var aF=new MEI2VF.EventLink(aG,null);aF.setParams({linkCond:aD});aE.push(aF)};var z=function(aI,aD){var aE=function(aK,aJ){return(aK&&aJ&&aK.pname===aJ.pname&&aK.oct===aJ.oct&&aK.system===aJ.system)};if(!aD.pname||!aD.oct){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or specified for the tie")}var aH=false;var aF;var aG;for(aF=0;!aH&&aF<ag.length;++aF){aG=ag[aF];if(!aG.getLastId()){if(aE(aG.params.linkCond,aD)){aH=true;aG.setLastId(aI)}else{}}}if(!aH){var aG=new MEI2VF.EventLink(null,aI);ag.push(aG)}};var e=function(aJ,aD){var aF=function(aL,aK){return aL.nesting_level===aK.nesting_level&&aL.system===aK.system};var aI=false;var aH=0;var aE;for(aH=0;!aI&&aH<C.length;++aH){var aG=C[aH];if(aG&&!aG.getLastId()&&aF(aG.params.linkCond,aD)){aI=true;aG.setLastId(aJ)}}if(!aI){var aG=new MEI2VF.EventLink(null,aJ);C.push(aG)}};var d=function(aE){var aD=[];var aF=aE.split(" ");$.each(aF,function(aH,aI){var aG;if(aI.length===1){aD.push({letter:aI,nesting_level:0})}else{if(aI.length===2){if(!(aG=Number(aI[1]))){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}aD.push({letter:aI[0],nesting_level:aG})}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}}});return aD};var m=function(aE,aJ,aU,aL){var aS=function(aV){return(new Vex.Flow.Annotation(aV)).setFont("Times").setBottom(true)};var aD=function(aV){return(new Vex.Flow.Annotation(aV)).setFont("Times")};try{var aG=new Vex.Flow.StaveNote({keys:[G(aE)],clef:I($(aU).attr("n")),duration:i(aE),stem_direction:V(aE,aU)});aG.addAnnotation(2,aS(at(aE)));var aM=r(aL,aE);aG.addAnnotation(2,aM[1]=="below"?aS(aM[0]):aD(aM[0]));try{var aT;for(aT=0;aT<parseInt($(aE).attr("dots"));aT++){aG.addDotToAll()}}catch(aN){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(aE.attrs())+'. "'+aN.toString()+'"')}var aI=$(aE).attr("accid");if(aI){aG.addAccidental(0,new Vex.Flow.Accidental(T(aI)))}$.each($(aE).find("artic"),function(aW,aV){aG.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(aV).attr("artic")]).setPosition(mei2vexflowTables.positions[$(aV).attr("place")]))});$.each($(aE).children(),function(aV,aW){$(aW).remove()});var aK=$(aE).attr("xml:id");if(!aK){aK=MeiLib.createPseudoUUID();$(aE).attr("xml:id",aK)}var aO=$(aE).attr("tie");if(!aO){aO=""}var aF=$(aE).attr("pname");if(!aF){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute")}var aR=$(aE).attr("oct");if(!aR){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute")}for(var aT=0;aT<aO.length;++aT){switch(aO[aT]){case"i":v(aK,{pname:aF,oct:aR,system:F},ag);break;case"t":z(aK,{pname:aF,oct:aR,system:F});break}}var aH=$(aE).attr("slur");if(aH){var aP=d(aH);$.each(aP,function(aW,aV){switch(aV.letter){case"i":v(aK,{nesting_level:aV.nesting_level,system:F},C);break;case"t":e(aK,{nesting_level:aV.nesting_level,system:F});break}})}var aQ={vexNote:aG,id:aK};O.push(aQ);k[aK]={meiNote:aE,vexNote:aG};return aQ}catch(aN){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(aE.attrs())+'. "'+aN.toString()+'"')}};var Z=function(aG,aF,aE,aI){try{var aH=new Vex.Flow.StaveNote({keys:["c/5"],duration:i(aG,false)+"r"});if($(aG).attr("dots")==="1"){aH.addDotToAll()}return aH}catch(aD){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(aG.attrs())+'. "'+aD.toString()+'"')}};var aq=function(aG,aF,aE,aI){try{var aH=new Vex.Flow.StaveNote({keys:["c/5"],duration:"wr"});return aH}catch(aD){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(aG.attrs())+'. "'+aD.toString()+'"')}};var o=function(aF,aE,aD,aH){var aG=$(aF).children().map(function(aI,aJ){var aK=J(aJ,aE,aD,aH);return aK.vexNote?aK.vexNote:aK}).get();ar.push(new Vex.Flow.Beam(aG));return aG};var B=function(aG,aD,aJ,aI){try{var aL=$(aG).children().map(G).get();var aE=aw(Math.max.apply(Math,$(aG).children().map(function(){return Number($(this).attr("dur"))}).get()));var aH=$(aG).children().map(function(){return $(this).attr("dots")==="1"}).get().any();if(aH===true){aE+="d"}var aF=new Vex.Flow.StaveNote({keys:aL,clef:I($(aJ).attr("n")),duration:aE});if(aH===true){aF.addDotToAll()}$(aG).children().each(function(aN,aO){var aM=$(aO).attr("accid");if(aM!==undefined){aF.addAccidental(aN,new Vex.Flow.Accidental(T(aM)))}});return aF}catch(aK){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+aK.toString())}};var J=function(aF,aE,aD,aH){var aG=$(aF).prop("localName");if(aG==="rest"){return Z(aF,aE,aD,aH)}else{if(aG==="mRest"){return aq(aF,aE,aD,aH)}else{if(aG==="note"){return m(aF,aE,aD,aH)}else{if(aG==="beam"){return o(aF,aE,aD,aH)}else{if(aG==="chord"){return B(aF,aE,aD,aH)}else{throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+aG+'" is not supported.')}}}}}};var U=function(aE,aD){if(!$.isArray(aD)){throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.")}var aF=new Vex.Flow.Voice({num_beats:Number($(E).find("staffDef").attr("meter.count")),beat_value:Number($(E).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});aF.setStrict(false);aF.addTickables(aD);return aF};aj(S);ai()};MEI2VF.EventLink=function(b,a){this.init(b,a)};MEI2VF.EventLink.prototype.init=function(b,a){this.first_ref=new MEI2VF.EventReference(b);this.last_ref=new MEI2VF.EventReference(a);this.params={}};MEI2VF.EventLink.prototype.setParams=function(a){this.params=a};MEI2VF.EventLink.prototype.setFirstRef=function(a){this.first_ref=a};MEI2VF.EventLink.prototype.setLastRef=function(a){this.last_ref=a};MEI2VF.EventLink.prototype.setFirstId=function(a){this.first_ref.setId(a)};MEI2VF.EventLink.prototype.setLastId=function(a){this.last_ref.setId(a)};MEI2VF.EventLink.prototype.setFirstTStamp=function(a){this.first_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setLastTStamp=function(a){this.last_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setContext=function(a){this.meicontext=a};MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})};MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})};MEI2VF.EventReference=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setId=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setTStamp=function(a){this.tstamp=a;if(this.xmlid){this.tryResolveReference(true)}};MEI2VF.EventReference.prototype.tryResolveReference=function(b){var a=this.tstamp;var c=this.meicontext;if(!a){throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.")}if(this.meicontext){this.xmlid=MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter)}else{this.xmlid=null}};MEI2VF.EventReference.prototype.getId=function(a){if(a&&a.meicontext){this.setContext(a.meicontext)}if(this.xmlid){return this.xmlid}if(this.tstamp){if(this.meicontext){this.tryResolveReference(a&&a.strict);return this.xmlid}}return null};MEI2VF.EventReference.prototype.setContext=function(a){this.meicontext=a};MEI2VF.StaffInfo=function(b,d,c,a){this.renderWith={clef:d,keysig:c,timesig:a};this.staffDef=b};MEI2VF.StaffInfo.prototype.look4changes=function(c,d){var a={clef:false,keysig:false,timesig:false};if(!c&&d){a.clef=true;a.keysig=true;a.keysig=true;return a}else{if(c&&!d){a.clef=false;a.keysig=false;a.keysig=false;return a}else{if(!c&&!d){throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.")}}}var b=function(g,e,f){return $(g).attr(f)===$(e).attr(f)};if(!b(c,d,"clef.shape")||!b(c,d,"clef.line")){a.clef=true}if((!b(c,d,"key.pname")||!b(c,d,"key.accid")||!b(c,d))){a.keysig=true}if(!b(c,d,"meter.count")||!b(c,d,"meter.unit")){a.timesig=true}return a};MEI2VF.StaffInfo.prototype.updateDef=function(a){this.renderWith=this.look4changes(this.staffDef,a);this.staffDef=a};MEI2VF.StaveConnector=function(b,a,c){this.init(b,a,c)};MEI2VF.StaveConnector.prototype.init=function(b,a,c){this.symbol=b;this.top_staff_n=a;this.bottom_staff_n=c};MEI2VF.StaveConnector.prototype.vexType=function(){switch(this.symbol){case"line":return Vex.Flow.StaveConnector.type.SINGLE;case"brace":return Vex.Flow.StaveConnector.type.BRACE;case"bracket":return Vex.Flow.StaveConnector.type.BRACKET;case"none":return null;default:return Vex.Flow.StaveConnector.type.SINGLE}};MEI2VF.StaffVoice=function(b,a){this.voice=b;this.staff_n=a};MEI2VF.StaveVoices=function(){this.all_voices=new Array()};MEI2VF.StaveVoices.prototype.addStaffVoice=function(a){this.all_voices.push(a)};MEI2VF.StaveVoices.prototype.addVoice=function(b,a){this.addStaffVoice(new MEI2VF.StaffVoice(b,a))};MEI2VF.StaveVoices.prototype.reset=function(){this.all_voices=[]};MEI2VF.StaveVoices.prototype.format=function(b){var a=$.map(this.all_voices,function(d,c){return d.voice});new Vex.Flow.Formatter().format(a,b)};MEI2VF.StaveVoices.prototype.draw=function(d,e){var c=this.all_voices;var b;for(var a=0;a<c.length;++a){b=c[a];b.voice.draw(d,e[b.staff_n])}};