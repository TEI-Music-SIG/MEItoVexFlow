mei2vexflowTables={};mei2vexflowTables.positions={above:Vex.Flow.Modifier.Position.ABOVE,below:Vex.Flow.Modifier.Position.BELOW};mei2vexflowTables.hairpins={cres:Vex.Flow.StaveHairpin.type.CRESC,dim:Vex.Flow.StaveHairpin.type.DECRESC};mei2vexflowTables.articulations={acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"};var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.EventEnumerator=function(a){this.init(a)};MeiLib.EventEnumerator.prototype.init=function(a){if(!a){throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined")}this.node=a;this.next_evnt=null;this.EoI=true;this.children=$(this.node).children();this.i_next=-1;this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")};MeiLib.EventEnumerator.prototype.read_ahead=function(){if(this.beam_enumerator){if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true;this.beam_enumerator=null;this.step_ahead()}}else{this.step_ahead()}};MeiLib.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if(a==="note"||a==="rest"||a==="mRest"||a==="chord"){this.EoI=false}else{if(a==="beam"){this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt);if(!this.beam_enumerator.EoI){this.next_evnt=this.beam_enumerator.nextEvent();this.EoI=false}else{this.EoI=true}}}}else{this.EoI=true}};MeiLib.durationOf=function(f,c){IsSimpleEvent=function(g){return(g==="note"||g==="rest"||g==="space")};var e=function(h,i){var g=$(f).attr("dur");if(!g){throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note> or <rest> must be specified.")}return MeiLib.dur2beats(Number(g),i)};var d=function(j,h,i){if(!i){i="1"}var g=$(j).attr("dur");if(g){return MeiLib.dur2beats(Number(g),h)}$(j).find("note").each(function(){lyr_n=$(this).attr("layer");if(!lyr_n||lyr_n===i){var k=$(this).attr("dur");if(!g&&k){g=k}else{if(g&&g!=k){throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}}});if(g){return MeiLib.dur2beats(Number(g),h)}throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")};var a=function(g,i){var h=0;g.children().each(function(){var l;var k;var j=this.prop("localName");if(IsSimpleEvent(j)){l=e(this,i)}else{if(j==="chord"){l=d(this,i)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+j+"'")}}h+=l});return h};var b=$(f).prop("localName");if(IsSimpleEvent(b)){return e(f,c)}else{if(b==="mRest"){return c.count}else{if(b==="chord"){return d(f,c)}else{if(b==="beam"){return a(f,c)}else{throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'")}}}}};MeiLib.tstamp2id=function(i,h,c){var j=Number(i);var b=0;var f=function(){return b+1};var g=function(){return j-f()};var a=new MeiLib.EventEnumerator(h);var n;var l;var k;var d;while(!a.EoI&&(l===undefined||l>0)){k=n;d=l;n=a.nextEvent();l=g();b+=MeiLib.durationOf(n,c)}if(l===undefined){return undefined}var e;if(l<0){if(k&&d<Math.abs(l)){e=k}else{e=n}}else{e=n}var m;m=$(e).attr("xml:id");if(!m){m=MeiLib.createPseudoUUID();$(e).attr("xml:id",m)}return m};MeiLib.tstamp2idInContext=function(a,c){var e;var d=false;for(var b=0;b<c.length&&!d;++b){Vex.LogDebug("<<<< Measure "+b+" >>>>");if(c[b].meter){e=c[b].meter}if(b===0&&!e){throw new MeiLib.RuntimeError("MeiLib.tstamp2id:E001","No time signature specified")}}throw new MeiLib.RuntimeError("MeiLib.E002",'No event with xml:id="'+eventid+'" was found in the given MEI context.')};MeiLib.id2tstamp=function(b,d){var f;var e=false;for(var c=0;c<d.length&&!e;++c){Vex.LogDebug("<<<< Measure "+c+" >>>>");if(d[c].meter){f=d[c].meter}if(c===0&&!f){throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified")}var a=MeiLib.sumUpUntil(b,d[c].layer,f);if(a.found){e=true;return c.toString()+"m+"+(a.beats+1).toString()}}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+b+'" was found in the given MEI context.')};MeiLib.dur2beats=function(a,b){return(b.unit/a)};MeiLib.beats2dur=function(a,b){return(b.unit/a)};MeiLib.sumUpUntil=function(b,c,d){var a=function(o){var g=$(o);var l=g.prop("localName");if(l==="note"||l==="rest"){if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var e=Number(g.attr("dur"));if(!e){throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).")}var j=Number(g.attr("dots"));var m=MeiLib.dur2beats(e,d);return{beats:m,found:false}}}else{if(l==="mRest"){if(g.attr("xml:id")===b){p=true;return{beats:0,found:true}}else{return{beats:d.count,found:false}}}else{if(l==="layer"||l==="beam"){var m=0;var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m+=k.beats;p=k.found}return{beats:m,found:p}}else{if(l==="chord"){var n=g.attr("dur");if(g.attr("xml:id")===b){return{beats:0,found:true}}else{var n=g.attr("dur");if(n){if(g.find("[xml\\:id='"+b+"']")){return{beats:0,found:true}}else{return{beats:MeiLib.dur2beats(n,d),found:p}}}else{var f=g.children();var p=false;for(var h=0;h<f.length&&!p;++h){var k=a(f[h]);m=k.beats;p=k.found}return{beats:m,found:p}}}}}}}return{beats:0,found:false}};return a(c)};Node.prototype.attrs=function(){var b;var a={};for(b in this.attributes){a[this.attributes[b].name]=this.attributes[b].value}return a};Array.prototype.all=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===false){return false}}return true};Array.prototype.any=function(b){b=b||function(c){return c==true};var a;for(a=0;a<this.length;a++){if(b(this[a])===true){return true}}return false};MEI2VF={};MEI2VF.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};MEI2VF.render_notation=function(g,a,b,h){var b=b||800;var h=h||350;var K=$(g).find("measure").get().length;var r=Math.round(b/K);var aq;var e=[];var ac=[];var ak=[];var C={};var F=[];var am=[];var l=[];var af=[];var B=20;var x=0;var ae=0;var c=0;var Z=0;var D=0;var ai=false;var W=true;var I=new Array();var P=function(){if(W){D=0;ae=0;W=false;ai=false;$.each(I,function(au,av){if(av){av.renderWith.clef=true;av.renderWith.keysig=true;av.renderWith.timesig=true}})}else{if(ai){D=0;ae=0;Z+=1;x=c+B;ai=false;$.each(I,function(au,av){if(av){av.renderWith.clef=true;av.renderWith.keysig=true}})}else{if(e[e.length-1]){var at=e[e.length-1][0];ae=at.x+at.width}else{ae=0}}}};var ad=function(au,av){var at=ab(au,av);if(!at){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+av+" is mandatory.")}return at};var ab=function(au,av){var at=$(au).attr(av);return at};var R=function(au){au=(typeof au==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:au;var av=$(au).attr("pname");var at=$(au).attr("oct");if(!av||!at){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>")}return av+"/"+at};var ah=function(at){var av=$(at).find("syl");var au="";$(av).each(function(ax,ay){var az=($(ay).attr("wordpos")=="i"||$(ay).attr("wordpos")=="m")?"-":"";au+=(ax>0?"\n":"")+$(ay).text()+az});var aw=(av.attr("wordpos")=="i"||av.attr("wordpos")=="m")?"-":"";return au};var E=function(ax,au){var av=$(ax).find("dir");var at="";var aw="";$(av).each(function(){var aA=ad(this,"startid");var az=ad(au,"xml:id");var ay=ad(this,"place");if(aA===az){at+=$(this).text().trim();aw=ay}});return[at,aw]};var s=function(au,at){au={pitch:au.split("/")[0][0],octave:Number(au.split("/")[1])};at={pitch:at.split("/")[0][0],octave:Number(at.split("/")[1])};if(au.octave===at.octave){if(au.pitch===at.pitch){return 0}else{if(au.pitch<at.pitch){return -1}else{if(au.pitch>at.pitch){return 1}}}}else{if(au.octave<at.octave){return -1}else{if(au.octave>at.octave){return 1}}}};var y=function(at){at=String(at);if(at==="1"){return"w"}if(at==="2"){return"h"}if(at==="4"){return"q"}if(at==="8"){return"8"}if(at==="16"){return"16"}if(at==="32"){return"32"}if(at==="64"){return"64"}throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+at+'" is not supported.')};var o=function(at,aw){aw=aw||true;at=(typeof at==="number"&&arguments.length===2&&typeof arguments[1]==="object")?arguments[1]:at;var au=$(at).attr("dur");if(au===undefined){alert("Could not get duration from:\n"+JSON.stringify(at,null,"\t"))}var av=y(au);if(aw===true&&$(at).attr("dots")==="1"){av+="d"}return av};var X=function(at){if(at==="n"){return"n"}if(at==="f"){return"b"}if(at==="s"){return"#"}if(at==="ff"){return"bb"}if(at==="ss"){return"##"}throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+at)};var k=function(au,at){var av=$(au).attr("stem.dir");if(av!==undefined){return(av==="up")?Vex.Flow.StaveNote.STEM_UP:(av==="down")?Vex.Flow.StaveNote.STEM_DOWN:undefined}else{var aw=al($(at).attr("n"));if(aw==="treble"){return(s("a/5",R(au))===1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}else{if(aw==="bass"){return(s("c/4",R(au))===-1)?Vex.Flow.StaveNote.STEM_UP:Vex.Flow.StaveNote.STEM_DOWN}}}};var j=function(at){if($(at).attr("key.pname")!==undefined){var aw=$(at).attr("key.pname").toUpperCase();var av=$(at).attr("key.accid");if(av!==undefined){switch(av){case"s":aw+="#";break;case"f":aw+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}}var au=$(at).attr("key.mode");if(au!==undefined){aw+=au==="major"?"":"m"}return aw}else{return"C"}};var H=function(at){var au=ad(at,"clef.shape");var av=ab(at,"clef.line");if(au==="G"&&(!av||av==="2")){return"treble"}else{if(au==="F"&&(!av||av==="4")){return"bass"}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+au+'" '+(av?('clef.line="'+av+'"'):"")+" ]")}}};var al=function(at){var au=$(g).find("staffDef[n="+at+"]")[0];return H(au)};var q=function(at){if($(at).attr("meter.count")!==undefined&&$(at).attr("meter.unit")!==undefined){return $(at).attr("meter.count")+"/"+$(at).attr("meter.unit")}};var U=function(at){var au=new Vex.Flow.Renderer(at,Vex.Flow.Renderer.Backends.CANVAS);aq=au.getContext()};var T=function(at){return 100};var w=function(av){var at=0;var au;for(au=0;au<av-1;au++){at+=T(au)}return at};var f=function(av){var at=x+w(av);var au=at+T(av);if(au>c){c=au}return at};var d=function(av,au){if(!av){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".')}P();var aw=I[av].staffDef;if(I[av].renderWith.clef||I[av].renderWith.keysig||I[av].renderWith.timesig){au+=30}var at=new Vex.Flow.Stave(ae,f(av),au);if(I[av].renderWith.clef){at.addClef(H(aw));I[av].renderWith.clef=false}if(I[av].renderWith.keysig){if($(aw).attr("key.sig.show")==="true"||$(aw).attr("key.sig.show")===undefined){at.addKeySignature(j(aw))}I[av].renderWith.keysig=false}if(I[av].renderWith.timesig){if($(aw).attr("meter.rend")==="norm"||$(aw).attr("meter.rend")===undefined){at.addTimeSignature(q(aw))}I[av].renderWith.timesig=false}at.setContext(aq).draw();return at};var ar=function(ax,au,aA,av,az,ay,aw){var at=new Vex.Flow.Stave(az,ay,aw);if(au===true){at.addClef(H(ax))}if(aA===true){if($(ax).attr("key.sig.show")==="true"||$(ax).attr("key.sig.show")===undefined){at.addKeySignature(j(ax))}}if(av===true){if($(ax).attr("meter.rend")==="norm"||$(ax).attr("meter.rend")===undefined){at.addTimeSignature(q(ax))}}at.setContext(aq).draw();return at};var ap=function(){var at=$(g).find("scoreDef")[0];if(!at){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.")}Y(at);$(g).find("section").children().each(J);$.each(ac,function(av,au){au.setContext(aq).draw()});aa(F);aa(am);O(l)};var aa=function(at){$(at).each(function(ax,ay){var av=C[ay.getFirstId()];var az=C[ay.getLastId()];var aw;if(av){aw=av.vexNote}var au;if(az){au=az.vexNote}new Vex.Flow.StaveTie({first_note:aw,last_note:au}).setContext(aq).draw()})};var O=function(at){$(at).each(function(aw,aB){var aC=C[aB.getFirstId()];var ay=C[aB.getLastId()];var aA;if(aC){aA=aC.vexNote}var au;if(ay){au=ay.vexNote}var av=mei2vexflowTables.positions[aB.hairpinParams.place];var az=mei2vexflowTables.hairpins[aB.hairpinParams.form];var ax=0;var aE=0;var aD={height:10,y_shift:0,left_shift_px:ax,r_shift_px:aE};new Vex.Flow.StaveHairpin({first_note:aA,last_note:au,},az).setContext(aq).setRenderOptions(aD).setPosition(av).draw()})};var J=function(at,au){switch($(au).prop("localName")){case"measure":G(au);M(au,"tie",F);M(au,"slur",am);M(au,"hairpin",l);break;case"scoreDef":Y(au);break;case"staffDef":m(au);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(au).prop("localName")+"> is not supported in <section>")}};var Y=function(at){$(at).children().each(i)};var i=function(at,au){switch($(au).prop("localName")){case"staffGrp":N(au);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(au).prop("localName")+"> is not supported in <scoreDef>")}};var N=function(at){$(at).children().each(n)};var n=function(at,au){switch($(au).prop("localName")){case"staffDef":m(au);break;case"staffGrp":N(au);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(au).prop("localName")+"> is not supported in <staffGrp>")}};var m=function(at){var au=Number(at.attrs().n);var av=I[au];if(av){I[au].updateDef(at)}else{I[au]=new MEI2VF.StaffInfo(at,true,true,true)}};var G=function(at){e.push($(at).find("staff").map(function(av,au){return S(av,au,at)}).get())};var S=function(av,az,ay){var aD,at,aB;var au=Number(az.attrs().n);aD=d(au,r);var aA=$(az).find("layer").map(function(aF,aE){return A(aF,aE,az,ay)}).get();var aw=[];$(aA).each(function(){aw.push({events:$(this.events).get().map(function(aE){return aE.vexNote?aE.vexNote:aE}),layer:this.layer})});var ax=$.map(aw,function(aE){return L(null,aE.events)});var aC=new Vex.Flow.Formatter().joinVoices(ax).format(ax,r).formatToStave(ax,aD);$.each(ax,function(aE,aF){aF.draw(aq,aD)});return aD};var A=function(aw,ax,az,ay){var at=ay.attrs().n;if(!at){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified")}var av=az.attrs().n;if(!av){av="1"}var au=ax.attrs().n;if(!au){au="1"}var aA=I[av].staffDef;var aB=at+":"+av+":"+au;if(af[aB]){$(af[aB]).each(function(aC,aD){var aF=$(aA).attr("meter.count");var aE=$(aA).attr("meter.unit");var aG={count:Number(aF),unit:Number(aE)};aD.setContext({layer:ax,meter:aG});af[aB][aC]=null});af[aB]=null}return{layer:aw,events:$(ax).children().map(function(aD,aC){return V(aC,ax,az,ay)}).get()}};var M=function(az,aA,av){var at=function(aD){var aC=aD.attrs().staff;if(!aC){aC="1"}var aB=aD.attrs().layer;if(!aB){aB="1"}return{staff_n:aC,layer_n:aB}};var au=function(aF,aD,aB){var aH=at(aD);var aJ=$(aB).find('staff[n="'+aH.staff_n+'"]');var aE=$(aJ).find('layer[n="'+aH.layer_n+'"]').get(0);if(!aE){var aI=$(aJ).find("layer");if(aI&&!aI.attr("n")){aE=aI}if(!aE){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}}var aG=I[aH.staff_n].staffDef;if(!aG){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.")}var aC={count:Number(aG.attrs()["meter.count"]),unit:Number(aG.attrs()["meter.unit"])};if(!aC.count||!aC.unit){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.")}return MeiLib.tstamp2id(aF,aE,aC)};var ay=function(aC){var aB;return aC.substring(0,aC.indexOf("m"))};var aw=function(aC){var aB;return aC.substring(aC.indexOf("+")+1)};var ax=$(az).find(aA);$.each(ax,function(aL,aJ){var aE=new MEI2VF.EventLink(null,null);if(aA==="hairpin"){var aD=aJ.attrs().form;if(!aD){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.")}var aH=aJ.attrs().place;aE.setHairpinParams({form:aD,place:aH})}var aG=aJ.attrs().startid;if(aG){aE.setFirstId(aG)}else{var aM=aJ.attrs().tstamp;if(aM){aG=au(aM,aJ,az);aE.setFirstId(aG)}else{}}var aK=aJ.attrs().endid;if(aK){aE.setLastId(aK)}else{var aI=aJ.attrs().tstamp2;if(aI){var aF=Number(ay(aI));if(aF>0){aE.setLastTStamp(aw(aI));var aC=at(aJ);var aB=az.attrs().n;var aN=Number(aB)+aF;var aO=aN.toString()+":"+aC.staff_n+":"+aC.layer_n;if(!af[aO]){af[aO]=new Array()}af[aO].push(aE)}else{aK=au(aw(aI),aJ,az);aE.setLastId(aK)}}else{}}av.push(aE)})};var ao=function(aw,av,at){var au=new MEI2VF.EventLink(aw,av);at.push(au)};var v=function(aw,at,au){var av=new MEI2VF.EventLink(aw,null,at);au.push(av)};var z=function(az,av){if(!av){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch specified for the tie")}var ay=false;var au;var ax;for(au=0;!ay&&au<F.length;++au){ax=F[au];if(!ax.getLastId()){if(ax.linkCond===av){ay=true;ax.setLastId(az)}else{var at=ax.getFirstId();if(at){var aw=C[at];if(aw&&$(aw.meiNote).attr("pname")===av){ay=true;ax.setLastId(az)}}}}}if(!ay){var ax=new MEI2VF.EventLink(null,az);F.push(ax)}};var Q=function(ay,at){var ax=false;var aw=0;var au;for(aw=0;!ax&&aw<am.length;++aw){var av=am[aw];if(av&&!av.getLastId()&&av.linkCond===at){ax=true;av.setLastId(ay)}}if(!ax){var av=new MEI2VF.EventLink(null,ay);am.push(av)}};var an=function(au){var at=[];var av=au.split(" ");$.each(av,function(ax,ay){var aw;if(ay.length===1){at.push({letter:ay,nesting_level:0})}else{if(ay.length===2){if(!(aw=Number(ay[1]))){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}at.push({letter:ay[0],nesting_level:aw})}else{throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute")}}});return at};var aj=function(aA,at,aE,aC){var az=function(aK){return(new Vex.Flow.Annotation(aK)).setFont("Times").setBottom(true)};var av=function(aK){return(new Vex.Flow.Annotation(aK)).setFont("Times")};try{var aG=new Vex.Flow.StaveNote({keys:[R(aA)],clef:al($(aE).attr("n")),duration:o(aA),stem_direction:k(aA,aE)});aG.addAnnotation(2,az(ah(aA)));var au=E(aC,aA);aG.addAnnotation(2,au[1]=="below"?az(au[0]):av(au[0]));try{var ay;for(ay=0;ay<parseInt($(aA).attr("dots"));ay++){aG.addDotToAll()}}catch(aH){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(aA.attrs())+'. "'+aH.toString()+'"')}var ax=$(aA).attr("accid");if(ax){aG.addAccidental(0,new Vex.Flow.Accidental(X(ax)))}$.each($(aA).find("artic"),function(aL,aK){aG.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(aK).attr("artic")]).setPosition(mei2vexflowTables.positions[$(aK).attr("place")]))});$.each($(aA).children(),function(aK,aL){$(aL).remove()});var aI=$(aA).attr("xml:id");if(!aI){aI=MeiLib.createPseudoUUID();$(aA).attr("xml:id",aI)}var aB=$(aA).attr("tie");if(!aB){aB=""}var aw=$(aA).attr("pname");if(!aw){throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute")}for(var ay=0;ay<aB.length;++ay){switch(aB[ay]){case"i":v(aI,aw,F);break;case"t":z(aI,aw);break}}var aJ=$(aA).attr("slur");if(aJ){var aF=an(aJ);$.each(aF,function(aL,aK){switch(aK.letter){case"i":v(aI,aK.nesting_level,am);break;case"t":Q(aI,aK.nesting_level);break}})}var aD={vexNote:aG,id:aI};ak.push(aD);C[aI]={meiNote:aA,vexNote:aG};return aD}catch(aH){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(aA.attrs())+'. "'+aH.toString()+'"')}};var ag=function(aw,av,au,ay){try{var ax=new Vex.Flow.StaveNote({keys:["c/5"],duration:o(aw,false)+"r"});if($(aw).attr("dots")==="1"){ax.addDotToAll()}return ax}catch(at){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(aw.attrs())+'. "'+at.toString()+'"')}};var t=function(aw,av,au,ay){try{var ax=new Vex.Flow.StaveNote({keys:["c/5"],duration:"wr"});return ax}catch(at){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(aw.attrs())+'. "'+at.toString()+'"')}};var u=function(av,au,at,ax){var aw=$(av).children().map(function(ay,az){var aA=V(az,au,at,ax);return aA.vexNote?aA.vexNote:aA}).get();ac.push(new Vex.Flow.Beam(aw));return aw};var p=function(aw,at,az,ay){try{var aB=$(aw).children().map(R).get();var au=y(Math.max.apply(Math,$(aw).children().map(function(){return Number($(this).attr("dur"))}).get()));var ax=$(aw).children().map(function(){return $(this).attr("dots")==="1"}).get().any();if(ax===true){au+="d"}var av=new Vex.Flow.StaveNote({keys:aB,clef:al($(az).attr("n")),duration:au});if(ax===true){av.addDotToAll()}$(aw).children().each(function(aD,aE){var aC=$(aE).attr("accid");if(aC!==undefined){av.addAccidental(aD,new Vex.Flow.Accidental(X(aC)))}});return av}catch(aA){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+aA.toString())}};var V=function(av,au,at,ax){var aw=$(av).prop("localName");if(aw==="rest"){return ag(av,au,at,ax)}else{if(aw==="mrest"){return t(av,au,at,ax)}else{if(aw==="note"){return aj(av,au,at,ax)}else{if(aw==="beam"){return u(av,au,at,ax)}else{if(aw==="chord"){return p(av,au,at,ax)}else{throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+aw+'" is not supported.')}}}}}};var L=function(au,at){if(!$.isArray(at)){throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.")}var av=new Vex.Flow.Voice({num_beats:Number($(g).find("staffDef").attr("meter.count")),beat_value:Number($(g).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});av.setStrict(false);av.addTickables(at);return av};U(a);ap()};MEI2VF.EventLink=function(c,a,b){this.first_ref=new MEI2VF.EventReference(c);this.last_ref=new MEI2VF.EventReference(a);this.linkCond=b};MEI2VF.EventLink.prototype.setHairpinParams=function(a){this.hairpinParams=a};MEI2VF.EventLink.prototype.setFirstRef=function(a){this.first_ref=a};MEI2VF.EventLink.prototype.setLastRef=function(a){this.last_ref=a};MEI2VF.EventLink.prototype.setFirstId=function(a){this.first_ref.setId(a)};MEI2VF.EventLink.prototype.setLastId=function(a){this.last_ref.setId(a)};MEI2VF.EventLink.prototype.setFirstTStamp=function(a){this.first_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setLastTStamp=function(a){this.last_ref.setTStamp(a)};MEI2VF.EventLink.prototype.setContext=function(a){this.meicontext=a};MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})};MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})};MEI2VF.EventReference=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setId=function(a){this.xmlid=a};MEI2VF.EventReference.prototype.setTStamp=function(a){this.tstamp=a;if(this.xmlid){this.tryResolveReference(true)}};MEI2VF.EventReference.prototype.tryResolveReference=function(b){var a=this.tstamp;var c=this.meicontext;if(!a){throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.")}if(this.meicontext){this.xmlid=MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter)}else{this.xmlid=null}};MEI2VF.EventReference.prototype.getId=function(a){if(a&&a.meicontext){this.setContext(a.meicontext)}if(this.xmlid){return this.xmlid}if(this.tstamp){if(this.meicontext){this.tryResolveReference(a&&a.strict);return this.xmlid}}return null};MEI2VF.EventReference.prototype.setContext=function(a){this.meicontext=a};MEI2VF.StaffInfo=function(b,d,c,a){this.renderWith={clef:d,keysig:c,timesig:a};this.staffDef=b};MEI2VF.StaffInfo.prototype.look4changes=function(d,b){var a={clef:false,keysig:false,timesig:false};if(!d&&b){a.clef=true;a.keysig=true;a.keysig=true;return a}else{if(d&&!new_staffDef){a.clef=false;a.keysig=false;a.keysig=false;return a}else{if(!d&&!new_staffDef){throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.")}}}var c=function(g,e,f){return $(g).attr(f)===$(e).attr(f)};if(!c(d,b,"clef.shape")||!c(d,b,"clef.line")){a.clef=true}if(!c(d,b,"key.pname")||!c(d,b,"key.accid")){a.keysig=true}if(!c(d,b,"meter.count")||!c(d,b,"meter.unit")){a.keysig=true}return a};MEI2VF.StaffInfo.prototype.updateDef=function(a){this.renderWith=look4changes(staffDef,a);this.staffDef=a};